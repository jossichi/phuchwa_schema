[
  {
    "_id": "users",
    "public": {
      "node_data": {
        "jsonSchema": {
          "_id": {
            "type": "string",
            "description": "ID duy nhất của người dùng do MongoDB tạo."
          },
          "user_id": {
            "type": "string",
            "unique": true,
            "description": "UUID duy nhất được tạo tự động."
          },
          "role": {
            "type": "string",
            "enum": ["nurse", "elderly"],
            "description": "Vai trò của người dùng: nurse (y tá) hoặc elderly (người cao tuổi)."
          },
          "email": {
            "type": "string",
            "description": "Email người dùng dùng để xác minh tài khoản."
          },
          "email_verified": {
            "type": "boolean",
            "default": false,
            "description": "Trạng thái xác minh email. Phải là true để hoàn tất đăng ký."
          },
          "hashed_password": {
            "type": "string",
            "nullable": true,
            "description": "Mật khẩu đã băm của người dùng (chỉ áp dụng cho elderly)."
          },
          "student_id": {
            "type": "string",
            "nullable": true,
            "description": "ID sinh viên của y tá (chỉ áp dụng cho nurse)."
          }
        },
        "jsonSample": [
          {
            "_id": "1",
            "user_id": "d2e9c02d-8450-406d-b3e5-bd8e7a0c889b",
            "role": "elderly",
            "email": "elderly1@example.com",
            "email_verified": true,
            "hashed_password": "2cf24dba5fb0a30e26e83b2ac5b9e29e1b161e5c1fa7425e73043362938b9824",
            "card_id": null
          },

          {
            "_id": "3",
            "user_id": "f512ab7d-4c8c-4dcf-b9c2-1a1a2e3b5d6e",
            "role": "nurse",
            "email": "nurse1@example.com",
            "email_verified": true,
            "hashed_password": null,
            "student_id": "abcd1234efgh5678ijkl9012mnop3456"
          },
          {
            "_id": "4",
            "user_id": "bd15f4b0-c0f0-44e9-9cd9-0ed6db233445",
            "role": "nurse",
            "email": "nurse2@example.com",
            "email_verified": false,
            "hashed_password": null,
            "student_id": "mnop1234abcd5678ijkl9012efgh3456"
          }
        ]
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$match": {
                  "email_verified": true,
                  "role": { "$in": ["nurse", "elderly"] }
                }
              },
              {
                "$addFields": {
                  "card_id": {
                    "$cond": {
                      "if": { "$eq": ["$role", "nurse"] },
                      "then": {
                        "$concat": ["CARD_", { "$substr": ["$user_id", 0, 8] }]
                      },
                      "else": null
                    }
                  },
                  "hashed_password": {
                    "$cond": {
                      "if": {
                        "$and": [
                          { "$eq": ["$role", "elderly"] },
                          { "$ne": ["$password", null] }
                        ]
                      },
                      "then": "bcrypt_hashed_password_placeholder",
                      "else": null
                    }
                  }
                }
              },
              {
                "$addFields": {
                  "user_id": {
                    "$cond": {
                      "if": { "$eq": ["$role", "nurse"] },
                      "then": {
                        "$concat": [
                          { "$substr": ["$hashed_student_id", 0, 5] },
                          "-",
                          {
                            "$toString": {
                              "$uuid": { "$concat": ["nurse-", "$$NOW"] }
                            }
                          }
                        ]
                      },
                      "else": {
                        "$concat": [
                          "EL-",
                          "$gender",
                          "-",
                          {
                            "$dateToString": {
                              "format": "%Y%m%d",
                              "date": "$created_at"
                            }
                          },
                          "-",
                          {
                            "$toString": {
                              "$uuid": { "$concat": ["elderly-", "$$NOW"] }
                            }
                          }
                        ]
                      }
                    }
                  }
                }
              },
              {
                "$facet": {
                  "nurse_data": [
                    {
                      "$match": { "role": "nurse" }
                    },
                    {
                      "$lookup": {
                        "from": "cards",
                        "localField": "user_id",
                        "foreignField": "user_id",
                        "as": "card_info"
                      }
                    },
                    {
                      "$addFields": {
                        "card_id": { "$arrayElemAt": ["$card_info.card_id", 0] }
                      }
                    },
                    {
                      "$project": {
                        "_id": 1,
                        "user_id": 1,
                        "email": 1,
                        "student_id": 1,
                        "card_id": 1,
                        "role": 1
                      }
                    }
                  ],
                  "elderly_data": [
                    {
                      "$match": { "role": "elderly" }
                    },
                    {
                      "$project": {
                        "_id": 1,
                        "user_id": 1,
                        "email": 1,
                        "hashed_password": 1,
                        "role": 1
                      }
                    }
                  ]
                }
              }
            ],
            "purpose": "Pipeline for extracting data from users and splitting into nurse_data and elderly_data.",
            "data_input_from_node": "users",
            "data_output_to_node": ["nurses", "elderies"]
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "PhucHwa System",
        "author": "LOC",
        "version": "2.2",
        "year": "2025"
      }
    }
  },

  {
    "_id": "cards",
    "public": {
      "node_data": {
        "jsonSchema": {
          "title": "CardData",
          "type": "object",
          "properties": {
            "_id": { "type": "string" },
            "card_id": {
              "type": "string",
              "description": "ID duy nhất của thẻ (có thể là QR code hoặc mã NFC)."
            },
            "hashed_student_id": {
              "type": "string",
              "nullable": true,
              "description": "băm ID sinh viên của nurse, liên kết với collection nurses."
            },
            "user_id": {
              "type": "string",
              "nullable": true,
              "description": "ID người dùng elderly, liên kết với collection elderlies."
            },
            "status": {
              "type": "string",
              "enum": ["active", "inactive", "revoked", "lost"],
              "default": "active",
              "description": "Trạng thái của thẻ: active (hoạt động), inactive (không hoạt động), revoked (bị thu hồi), lost (bị mất)."
            },
            "issued_by": {
              "type": "string",
              "default": "Green Card Company",
              "description": "Thực thể cấp phát thẻ (mặc định là công ty thẻ xanh)."
            },
            "issued_at": {
              "type": "string",
              "format": "date-time",
              "description": "Thời điểm cấp phát thẻ."
            },
            "expired_at": {
              "type": "string",
              "format": "date-time",
              "nullable": true,
              "description": "Ngày hết hạn thẻ (tùy chọn)."
            },
            "last_used_at": {
              "type": "string",
              "format": "date-time",
              "nullable": true,
              "description": "Lần cuối sử dụng QR hoặc NFC thẻ."
            },
            "public_key": {
              "type": "string",
              "description": "Khóa công khai để xác thực chữ ký số."
            },
            "private_key_encrypted": {
              "type": "string",
              "description": "Khóa riêng tư được mã hóa để bảo mật."
            },
            "qr_code_data": {
              "type": "string",
              "description": "Hình ảnh QR code được mã hóa dưới dạng Base64 (ví dụ: data:image/png;base64,iVBORw0KG...).",
              "pattern": "^data:image\\/([a-zA-Z+\\-\\.]+);base64,[a-zA-Z0-9+/=]+$"
            },
            "signature": {
              "type": "string",
              "description": "Chữ ký số được tạo từ hashed_student_id + card_id + user_id."
            }
          },
          "required": [
            "_id",
            "card_id",
            "status",
            "issued_by",
            "issued_at",
            "public_key",
            "private_key_encrypted",
            "qr_code_data",
            "signature"
          ],
          "additionalProperties": false
        },
        "jsonSample": [
          {
            "_id": "card_001",
            "card_id": "QR789012",
            "hashed_student_id": "STU123456",
            "user_id": null,
            "status": "active",
            "issued_by": "Green Card Company",
            "issued_at": "2023-10-01T12:00:00Z",
            "expired_at": "2025-10-01T12:00:00Z",
            "last_used_at": "2023-10-10T08:30:00Z",
            "public_key": "0xabc...xyz",
            "private_key_encrypted": "encrypted_private_key_123",
            "qr_code_data": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVQAAAFUCAYAAAB7ksS1AAAb…",
            "signature": "generated_signature_001"
          }
        ]
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$match": {
                  "card_id": { "$exists": true }
                }
              },
              {
                "$addFields": {
                  "role": {
                    "$cond": {
                      "if": { "$ne": ["$hashed_student_id", null] },
                      "then": "nurse",
                      "else": "elderly"
                    }
                  },
                  "status": "active",
                  "issued_by": "Green Card Company",
                  "issued_at": "$$NOW",
                  "expired_at": {
                    "$cond": {
                      "if": { "$eq": ["$role", "nurse"] },
                      "then": {
                        "$add": ["$$NOW", 63072000000]
                      },
                      "else": null
                    }
                  },
                  "signature": {
                    "$concat": ["$hashed_student_id", "$card_id", "$user_id"]
                  },
                  "qr_code_data": {
                    "$concat": [
                      "{\"card_id\":\"",
                      "$card_id",
                      "\",\"public_key\":\"",
                      "$public_key",
                      "\",\"issued_at\":\"",
                      "$$NOW",
                      "\"}"
                    ]
                  }
                }
              },
              {
                "$merge": {
                  "into": "cards",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Pipeline for assigning roles, generating signatures, and encoding QR data.",
            "data_input_from_node": "users",
            "data_output_to_node": "cards"
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "PhucHwa System",
        "author": "LOC",
        "version": "2.2",
        "year": "2025"
      }
    }
  },

  {
    "_id": "nurses",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "title": "Nurse",
          "description": "Schema for the nurses collection, containing detailed information about nurses.",
          "type": "object",
          "properties": {
            "_id": {
              "type": "string",
              "description": "ID duy nhất của tài liệu do MongoDB tạo."
            },
            "user_id": {
              "type": "string",
              "description": "UUID duy nhất được tạo tự động để xác định người dùng."
            },
            "email": {
              "type": "string",
              "format": "email",
              "description": "Email của y tá, dùng để xác minh tài khoản."
            },
            "card_id": {
              "type": "string",
              "description": "ID duy nhất của thẻ (có thể là QR code hoặc mã NFC)."
            },
            "hashed_student_id": {
              "type": "string",
              "description": "Băm ID sinh viên của y tá, liên kết với collection cards."
            },
            "public_key": {
              "type": "string",
              "description": "Khóa công khai để xác thực chữ ký số."
            },
            "private_key_encrypted": {
              "type": "string",
              "description": "Khóa riêng tư được mã hóa để bảo mật."
            },
            "qr_code_data": {
              "type": "string",
              "description": "Dữ liệu QR code chứa thông tin liên quan đến thẻ."
            },
            "gender": {
              "type": "boolean",
              "description": "Giới tính của y tá (true = male, false = female)."
            },
            "date_of_birth": {
              "type": "string",
              "format": "date",
              "description": "Ngày sinh của y tá (định dạng YYYY-MM-DD)."
            },
            "university": {
              "type": "string",
              "description": "Tên trường đại học của y tá."
            },
            "faculty": {
              "type": "string",
              "description": "Khoa học tập của y tá."
            },
            "degree_level": {
              "type": "string",
              "description": "Cấp độ học vấn (ví dụ: Bachelor, Master, PhD)."
            },
            "enrollment_year": {
              "type": "number",
              "description": "Năm nhập học của y tá."
            },
            "avatar_url": {
              "type": "string",
              "nullable": true,
              "description": "URL của ảnh đại diện đã băm."
            },
            "address": {
              "type": "string",
              "description": "Địa chỉ thường trú của y tá."
            },
            "service_level": {
              "type": "string",
              "enum": ["basic", "standard", "premium"],
              "description": "Mức dịch vụ: basic (cơ bản), standard (tiêu chuẩn), premium (cao cấp)."
            },
            "experience_years": {
              "type": "number",
              "description": "Số năm kinh nghiệm chăm sóc."
            },
            "certifications": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Danh sách chứng chỉ (ví dụ: sơ cấp, điều dưỡng chính thức)."
            },
            "average_rating": {
              "type": "number",
              "minimum": 0,
              "maximum": 5,
              "description": "Đánh giá trung bình từ elderly."
            },
            "committed_hours_per_week": {
              "type": "number",
              "description": "Số giờ làm việc cam kết/tuần."
            },
            "special_skills": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Kỹ năng đặc biệt (ví dụ: vật lý trị liệu cơ bản, sơ cứu)."
            },
            "quality_supervision_frequency": {
              "type": "string",
              "enum": ["quarterly", "monthly", "weekly"],
              "description": "Tần suất giám sát chất lượng: hàng quý, hàng tháng, hàng tuần."
            },
            "response_time_commitment": {
              "type": "string",
              "enum": ["24h", "12h", "4h"],
              "description": "Cam kết phản hồi yêu cầu: trong 24h, 12h hoặc 4h."
            },
            "availability": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "start_time": { "type": "string", "format": "date-time" },
                  "end_time": { "type": "string", "format": "date-time" }
                }
              },
              "description": "Thời gian rảnh của nurse."
            },
            "isAvailableForMatching": {
              "type": "boolean",
              "default": true,
              "description": "Trạng thái sẵn sàng matching."
            },
            "gpa": {
              "type": "number",
              "minimum": 0,
              "maximum": 4.0,
              "description": "Điểm tốt nghiệp chuyên môn y tế (GPA)."
            },
            "total_bookings": {
              "type": "integer",
              "minimum": 0,
              "description": "Tổng số lượt được elderly booking."
            },
            "total_feedback_count": {
              "type": "integer",
              "minimum": 0,
              "description": "Tổng số feedback từ elderly."
            },

            "ratio_feedbacks": {
              "type": "number",
              "minimum": 0,
              "description": "Tỷ lệ feedback tích cực so với tiêu cực (positive/negative)."
            },
            "specializations": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Các chuyên môn đặc biệt (ví dụ: Alzheimer care, Physical Therapy)."
            },
            "certificates": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Danh sách chứng chỉ liên quan (ví dụ: sơ cứu, CPR, chăm sóc đặc biệt)."
            },
            "updated_at": {
              "$dateToString": {
                "format": "%Y-%m-%dT%H:%M:%SZ",
                "date": "$$NOW"
              }
            }
          },
          "required": [
            "_id",
            "user_id",
            "email",
            "email_verified",
            "service_level",
            "experience_years",
            "certifications",
            "average_rating",
            "committed_hours_per_week",
            "special_skills",
            "quality_supervision_frequency",
            "response_time_commitment",
            "availability",
            "isAvailableForMatching",
            "updated_at"
          ],
          "additionalProperties": false
        },
        "jsonSample": [
          {
            "_id": "662b2f3d5f1e4c8a3a9d7e2c",
            "user_id": "f1a1b82c-9a94-4e39-b021-02b9b12c6ef1",
            "email": "nurse.jane@example.com",
            "card_id": "CARD123456789",
            "hashed_student_id": "b8c3a8c2f2d9b4f0d5c9f2e3b4d1e2f0",
            "public_key": "04d2a8c5bfa1c3e1f9d4b8d1e7f5b2a4d3c8e5f6b2d9e7f1c8b2f4d1e3b9c5d7e3",
            "private_key_encrypted": "ENCRYPTED_PRIVATE_KEY_STRING",
            "qr_code_data": "nurse:662b2f3d5f1e4c8a3a9d7e2c",
            "gender": false,
            "date_of_birth": "1995-06-15",
            "university": "Medical University of City",
            "faculty": "Nursing Science",
            "degree_level": "Bachelor",
            "enrollment_year": 2014,
            "avatar_url": "https://cdn.example.com/avatar/hashedavatar123.png",
            "address": "123 Main St, District 1, Ho Chi Minh City, Vietnam",
            "service_level": "premium",
            "experience_years": 5,
            "certifications": [
              "Registered Nurse Certification",
              "First Aid",
              "Advanced Cardiac Life Support"
            ],
            "average_rating": 4.7,
            "committed_hours_per_week": 40,
            "special_skills": [
              "Basic Physical Therapy",
              "Emergency Response",
              "Alzheimer Care"
            ],
            "quality_supervision_frequency": "monthly",
            "response_time_commitment": "12h",
            "availability": [
              {
                "start_time": "2025-04-27T08:00:00Z",
                "end_time": "2025-04-27T18:00:00Z"
              },
              {
                "start_time": "2025-04-28T08:00:00Z",
                "end_time": "2025-04-28T18:00:00Z"
              }
            ],
            "isAvailableForMatching": true,
            "gpa": 3.8,
            "total_bookings": 120,
            "total_feedback_count": 110,
            "ratio_feedbacks": 4.5,
            "specializations": [
              "Alzheimer Care",
              "Physical Therapy",
              "Palliative Care"
            ],
            "certificates": [
              "CPR Certification",
              "Wound Care Certification",
              "Elderly Care Certification"
            ],
            "updated_at": "2025-04-26T17:00:00Z"
          }
        ]
      }
    },

    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$match": {
                  "role": "nurse",
                  "email_verified": true
                }
              },
              {
                "$lookup": {
                  "from": "cards",
                  "localField": "user_id",
                  "foreignField": "user_id",
                  "as": "card_info"
                }
              },
              {
                "$addFields": {
                  "card_id": { "$arrayElemAt": ["$card_info.card_id", 0] },
                  "hashed_student_id": {
                    "$arrayElemAt": ["$card_info.hashed_student_id", 0]
                  },
                  "public_key": {
                    "$arrayElemAt": ["$card_info.public_key", 0]
                  },
                  "private_key_encrypted": {
                    "$arrayElemAt": ["$card_info.private_key_encrypted", 0]
                  },
                  "qr_code_data": {
                    "$arrayElemAt": ["$card_info.qr_code_data", 0]
                  },
                  "hashed_avatar_url": {
                    "$cond": {
                      "if": { "$ne": ["$avatar_url", null] },
                      "then": {
                        "$toHex": {
                          "$hash": {
                            "input": "$avatar_url",
                            "algorithm": "sha256"
                          }
                        }
                      },
                      "else": null
                    }
                  },
                  "updated_at": {
                    "$dateToString": {
                      "format": "%Y-%m-%dT%H:%M:%SZ",
                      "date": "$$NOW"
                    }
                  }
                }
              },
              {
                "$lookup": {
                  "from": "feedbacks",
                  "localField": "_id",
                  "foreignField": "to_user_id",
                  "as": "feedback_details"
                }
              },
              {
                "$addFields": {
                  "total_feedback_count": { "$size": "$feedback_details" },
                  "average_rating": {
                    "$avg": "$feedback_details.rating"
                  },
                  "positive_feedback_count": {
                    "$size": {
                      "$filter": {
                        "input": "$feedback_details",
                        "as": "feedback",
                        "cond": {
                          "$eq": [
                            "$$feedback.ai_sentiment_analysis",
                            "positive"
                          ]
                        }
                      }
                    }
                  },
                  "negative_feedback_count": {
                    "$size": {
                      "$filter": {
                        "input": "$feedback_details",
                        "as": "feedback",
                        "cond": {
                          "$eq": [
                            "$$feedback.ai_sentiment_analysis",
                            "negative"
                          ]
                        }
                      }
                    }
                  },
                  "ratio_feedbacks": {
                    "$cond": {
                      "if": { "$gt": ["$negative_feedback_count", 0] },
                      "then": {
                        "$divide": [
                          "$positive_feedback_count",
                          "$negative_feedback_count"
                        ]
                      },
                      "else": "$positive_feedback_count"
                    }
                  }
                }
              },
              {
                "$lookup": {
                  "from": "matching",
                  "localField": "_id",
                  "foreignField": "nurse_id",
                  "as": "booking_details"
                }
              },
              {
                "$addFields": {
                  "total_bookings": { "$size": "$booking_details" }
                }
              },
              {
                "$addFields": {
                  "service_level": {
                    "$switch": {
                      "branches": [
                        {
                          "case": {
                            "$and": [
                              { "$gte": ["$gpa", 3.5] },
                              { "$gte": ["$average_rating", 4.5] },
                              { "$gte": ["$ratio_feedbacks", 3] },
                              { "$in": ["Registered Nurse", "$certificates"] }
                            ]
                          },
                          "then": "premium"
                        },
                        {
                          "case": {
                            "$and": [
                              { "$gte": ["$gpa", 3.0] },
                              { "$gte": ["$average_rating", 4.0] },
                              { "$gte": ["$ratio_feedbacks", 2] },
                              { "$in": ["Basic Life Support", "$certificates"] }
                            ]
                          },
                          "then": "standard"
                        }
                      ],
                      "default": "basic"
                    }
                  }
                }
              },
              {
                "$project": {
                  "_id": 1,
                  "user_id": 1,
                  "email": 1,
                  "email_verified": 1,
                  "student_id": 1,
                  "card_id": 1,
                  "hashed_student_id": 1,
                  "public_key": 1,
                  "private_key_encrypted": 1,
                  "qr_code_data": 1,
                  "gender": 1,
                  "date_of_birth": 1,
                  "university": 1,
                  "faculty": 1,
                  "degree_level": 1,
                  "enrollment_year": 1,
                  "avatar_url": "$hashed_avatar_url",
                  "address": 1,
                  "gpa": 1,
                  "total_bookings": 1,
                  "total_feedback_count": 1,
                  "average_rating": 1,
                  "ratio_feedbacks": 1,
                  "specializations": 1,
                  "certificates": 1,
                  "service_level": 1,
                  "experience_years": 1,
                  "availability": 1,
                  "isAvailableForMatching": 1,
                  "updated_at": 1
                }
              },
              {
                "$merge": {
                  "into": "nurses",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Pipeline for extracting nurse data from users and cards, then merging into the nurses collection.",
            "data_input_from_node": ["users", "cards"],
            "data_output_to_node": "nurses"
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "PhucHwa System",
        "author": "LOC",
        "version": "2.2",
        "year": "2025"
      }
    }
  },

  {
    "_id": "elderies",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "title": "Elderly",
          "description": "Schema for the elderlies collection, containing detailed information about elderly users.",
          "type": "object",
          "properties": {
            "_id": {
              "type": "string",
              "description": "ID duy nhất của tài liệu do MongoDB tạo."
            },
            "user_id": {
              "type": "string",
              "description": "UUID duy nhất được tạo tự động để xác định người dùng."
            },
            "email": {
              "type": "string",
              "format": "email",
              "description": "Email của người cao tuổi, dùng để xác minh tài khoản."
            },
            "email_verified": {
              "type": "boolean",
              "default": false,
              "description": "Trạng thái xác minh email. Phải là true để hoàn tất đăng ký."
            },
            "hashed_password": {
              "type": "string",
              "nullable": true,
              "description": "Băm mật khẩu của người cao tuổi bằng thuật toán bcrypt."
            },

            "full_name": {
              "type": "string",
              "nullable": true,
              "description": "Họ và tên đầy đủ của người cao tuổi."
            },
            "gender": {
              "type": "boolean",
              "nullable": true,
              "description": "Giới tính của người cao tuổi (true = male, false = female)."
            },
            "date_of_birth": {
              "type": "string",
              "format": "date",
              "nullable": true,
              "description": "Ngày sinh của người cao tuổi (định dạng YYYY-MM-DD)."
            },
            "permanent_address": {
              "type": "object",
              "nullable": true,
              "description": "Địa chỉ hộ khẩu thường trú.",
              "properties": {
                "street": { "type": "string", "nullable": true },
                "city": { "type": "string", "nullable": true },
                "country": { "type": "string", "nullable": true }
              }
            },
            "current_address": {
              "type": "object",
              "nullable": true,
              "description": "Địa chỉ hiện tại đang sinh sống.",
              "properties": {
                "street": { "type": "string", "nullable": true },
                "city": { "type": "string", "nullable": true },
                "country": { "type": "string", "nullable": true }
              }
            },
            "insurance_number": {
              "type": "string",
              "nullable": true,
              "description": "Mã số bảo hiểm xã hội/y tế."
            },
            "phone_number": {
              "type": "string",
              "nullable": true,
              "description": "Số điện thoại liên hệ."
            },
            "avatar_url": {
              "type": "string",
              "nullable": true,
              "description": "URL của ảnh đại diện đã băm."
            },
            "updated_at": {
              "type": "string",
              "format": "date-time",
              "nullable": true,
              "description": "Ngày cập nhật hồ sơ gần nhất (ISO 8601)."
            }
          },
          "required": ["_id", "user_id", "email", "email_verified"],
          "additionalProperties": false
        },
        "jsonSample": [
          {
            "_id": "6630fac2b9e1f2b7c3a1d9e4",
            "user_id": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
            "email": "elder.ly@example.com",
            "email_verified": true,
            "hashed_password": "ef92b778bafe771e89245b89ecbc08a44a4e166c06659911881f383d4473e94f",
            "public_key": "0xdef...uvw",
            "private_key_encrypted": "encrypted_private_key_456",
            "qr_code_data": "{\"card_id\":\"QR987654\",\"user_id\":\"user_002\",\"public_key\":\"0xdef...uvw\"}"
          }
        ]
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$match": {
                  "role": "elderly",
                  "email_verified": true
                }
              },
              {
                "$lookup": {
                  "from": "cards",
                  "localField": "user_id",
                  "foreignField": "user_id",
                  "as": "card_info"
                }
              },
              {
                "$addFields": {
                  "hashed_password": {
                    "$cond": {
                      "if": { "$ne": ["$password", null] },
                      "then": "bcrypt_hashed_password_placeholder",
                      "else": null
                    }
                  },
                  "card_id": { "$arrayElemAt": ["$card_info.card_id", 0] },
                  "public_key": {
                    "$arrayElemAt": ["$card_info.public_key", 0]
                  },
                  "private_key_encrypted": {
                    "$arrayElemAt": ["$card_info.private_key_encrypted", 0]
                  },
                  "qr_code_data": {
                    "$arrayElemAt": ["$card_info.qr_code_data", 0]
                  },
                  "hashed_avatar_url": {
                    "$cond": {
                      "if": { "$ne": ["$avatar_url", null] },
                      "then": {
                        "$toHex": {
                          "$hash": {
                            "input": "$avatar_url",
                            "algorithm": "sha256"
                          }
                        }
                      },
                      "else": null
                    }
                  },
                  "updated_at": {
                    "$dateToString": {
                      "format": "%Y-%m-%dT%H:%M:%SZ",
                      "date": "$$NOW"
                    }
                  }
                }
              },
              {
                "$project": {
                  "_id": 1,
                  "user_id": 1,
                  "email": 1,
                  "email_verified": 1,
                  "hashed_password": 1,
                  "public_key": 1,
                  "private_key_encrypted": 1,
                  "qr_code_data": 1,
                  "full_name": 1,
                  "gender": 1,
                  "date_of_birth": 1,
                  "permanent_address": 1,
                  "current_address": 1,
                  "insurance_number": 1,
                  "phone_number": 1,
                  "avatar_url": "$hashed_avatar_url",
                  "updated_at": 1
                }
              },
              {
                "$merge": {
                  "into": "elderies",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Pipeline for extracting elderly data from users and cards, hashing the password, and merging into the elderlies collection.",
            "data_input_from_node": ["users", "cards"],
            "data_output_to_node": "elderies"
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "PhucHwa System",
        "author": "LOC",
        "version": "2.2",
        "year": "2025"
      }
    }
  },

  {
    "_id": "login_collection",
    "public": {
      "node_data": {
        "jsonSchema": {
          "title": "LogData",
          "type": "object",
          "properties": {
            "_id": {
              "type": "string",
              "description": "ID duy nhất của phiên đăng nhập."
            },
            "user_id": {
              "type": "string",
              "description": "ID người dùng liên kết với collection users."
            },
            "role": {
              "type": "string",
              "enum": ["nurse", "elderly"],
              "description": "Vai trò của người dùng: nurse (y tá) hoặc elderly (người cao tuổi)."
            },
            "card_id": {
              "type": "string",
              "nullable": true,
              "description": "ID thẻ QR (chỉ áp dụng cho nurse)."
            },
            "signature": {
              "type": "string",
              "nullable": true,
              "description": "Chữ ký số (chỉ áp dụng cho nurse)."
            },
            "token": {
              "type": "string",
              "nullable": true,
              "unique": true,
              "description": "Token duy nhất cho mỗi phiên đăng nhập (chỉ áp dụng cho nurse)."
            },
            "login_time": {
              "type": "string",
              "format": "date-time",
              "description": "Thời gian đăng nhập."
            },
            "logout_time": {
              "type": "string",
              "format": "date-time",
              "nullable": true,
              "description": "Thời gian đăng xuất (null nếu chưa đăng xuất)."
            }
          },
          "required": ["_id", "card_id", "user_id", "login_time"],
          "additionalProperties": false
        }
      },
      "jsonSample": [
        {
          "_id": "log_001",
          "user_id": "uuid-987654321",
          "role": "elderly",
          "login_time": "2023-10-01T10:00:00Z",
          "logout_time": null
        },
        {
          "_id": "log_002",
          "user_id": "uuid-123456789",
          "role": "nurse",
          "card_id": "QR789012",
          "signature": "signature_abc123",
          "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
          "login_time": "2023-10-01T12:00:00Z",
          "logout_time": null
        }
      ]
    },
    "private": {
      "node_function": {
        "edge": [
          [
            {
              "$match": {
                "email": "example@example.com",
                "hashed_password": "hashed_password_123"
              }
            },
            {
              "$lookup": {
                "from": "users",
                "localField": "user_id",
                "foreignField": "user_id",
                "as": "user_data"
              }
            },
            {
              "$addFields": {
                "isLoggedIn": true,
                "login_time": "$$NOW"
              }
            },
            {
              "$merge": {
                "into": "login_collection",
                "on": "user_id",
                "whenMatched": "merge",
                "whenNotMatched": "insert"
              }
            }
          ],
          [
            {
              "$match": {
                "card_id": "QR789012",
                "signature": "signature_abc123"
              }
            },
            {
              "$lookup": {
                "from": "cards",
                "localField": "card_id",
                "foreignField": "card_id",
                "as": "card_data"
              }
            },
            {
              "$lookup": {
                "from": "users",
                "localField": "user_id",
                "foreignField": "user_id",
                "as": "user_data"
              }
            },
            {
              "$addFields": {
                "is_authenticated": {
                  "$cond": {
                    "if": {
                      "$and": [
                        { "$eq": ["$card_data.public_key", "0xabc...xyz"] },
                        { "$eq": ["$user_data.role", "nurse"] }
                      ]
                    },
                    "then": true,
                    "else": false
                  }
                },
                "token": "generated_login_token",
                "login_time": "$$NOW"
              }
            },
            {
              "$merge": {
                "into": "login_collection",
                "on": "user_id",
                "whenMatched": "merge",
                "whenNotMatched": "insert"
              }
            }
          ]
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "PhucHwa System",
        "author": "LOC",
        "version": "2.2",
        "year": "2025"
      }
    }
  },

  {
    "_id": "test_attempts",
    "public": {
      "node_data": {
        "jsonSchema": {
          "title": "TestAttemptData",
          "type": "object",
          "properties": {
            "_id": { "type": "string" },
            "attempt_id": { "type": "string" },
            "questions": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "question": { "type": "string" },
                  "difficulty": {
                    "type": "string",
                    "enum": ["easy", "medium", "hard"]
                  },
                  "options": {
                    "type": "array",
                    "minItems": 4,
                    "maxItems": 4,
                    "items": {
                      "type": "string"
                    }
                  },
                  "correct_answer": { "type": "string" }
                },
                "required": [
                  "question",
                  "difficulty",
                  "options",
                  "correct_answer"
                ],
                "additionalProperties": false
              }
            },

            "timestamp": { "type": "string", "format": "date-time" }
          },
          "required": ["_id", "attempt_id", "questions", "timestamp"],
          "additionalProperties": false
        },
        "jsonSample": [
          {
            "_id": "test_attempt_001",
            "attempt_id": "attempt_001",
            "questions": [
              {
                "question": "Điều gì là nguyên nhân chính gây ra sốc phản vệ?",
                "difficulty": "hard",
                "options": [
                  "Viêm phổi",
                  "Phản ứng dị ứng nghiêm trọng",
                  "Nhiễm trùng huyết",
                  "Suy tim"
                ],
                "correct_answer": "Phản ứng dị ứng nghiêm trọng"
              },
              {
                "question": "Loại thuốc nào thường được sử dụng đầu tiên trong trường hợp ngừng tim?",
                "difficulty": "medium",
                "options": [
                  "Adrenaline",
                  "Atropine",
                  "Amiodarone",
                  "Lidocaine"
                ],
                "correct_answer": "Adrenaline"
              },
              {
                "question": "Kỹ thuật CPR tiêu chuẩn yêu cầu tỷ lệ ép ngực là bao nhiêu lần mỗi phút?",
                "difficulty": "easy",
                "options": [
                  "60-80 lần",
                  "80-100 lần",
                  "100-120 lần",
                  "120-140 lần"
                ],
                "correct_answer": "100-120 lần",
                "user_answer": "100-120 lần"
              },
              {
                "question": "Triệu chứng nào sau đây không phải là dấu hiệu của đột quỵ?",
                "difficulty": "medium",
                "options": [
                  "Đau ngực",
                  "Liệt nửa người",
                  "Khó nói",
                  "Mất thăng bằng"
                ],
                "correct_answer": "Đau ngực"
              },
              {
                "question": "Điều nào sau đây là chức năng chính của hệ bạch huyết?",
                "difficulty": "hard",
                "options": [
                  "Vận chuyển oxy",
                  "Bảo vệ cơ thể khỏi nhiễm trùng",
                  "Điều hòa huyết áp",
                  "Giảm cholesterol"
                ],
                "correct_answer": "Bảo vệ cơ thể khỏi nhiễm trùng"
              }
            ],
            "timestamp": "2023-10-01T12:00:00Z"
          }
        ]
      }
    },

    "personal": {
      "node_info": {
        "name": "Test Attempt Management",
        "author": "LOC",
        "version": "2.0",
        "year": "2025"
      }
    }
  },

  {
    "_id": "test_results",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "title": "TestResultData",
          "type": "object",
          "properties": {
            "_id": { "type": "string" },
            "attempt_id": { "type": "string" },
            "total_questions": { "type": "integer", "minimum": 1 },
            "correct_answers": { "type": "integer", "minimum": 0 },
            "score": { "type": "number", "minimum": 0, "maximum": 100 },
            "timestamp": { "type": "string", "format": "date-time" },
            "question_details": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "question": { "type": "string" },
                  "options": {
                    "type": "array",
                    "minItems": 4,
                    "maxItems": 4,
                    "items": { "type": "string" }
                  },
                  "correct_answer": { "type": "string" },
                  "user_answer": { "type": "string" },
                  "is_correct": { "type": "boolean" }
                },
                "required": [
                  "question",
                  "difficulty",
                  "options",
                  "correct_answer",
                  "user_answer",
                  "is_correct"
                ],
                "additionalProperties": false
              }
            },
            "current_score": { "type": "number", "minimum": 0, "maximum": 100 },
            "average_score": { "type": "number", "minimum": 0, "maximum": 100 }
          },
          "required": [
            "_id",
            "attempt_id",
            "total_questions",
            "correct_answers",
            "score",
            "timestamp",
            "question_details",
            "current_score",
            "average_score"
          ],
          "additionalProperties": false
        },
        "jsonSample": [
          {
            "_id": "result_001",
            "attempt_id": "attempt_001",
            "total_questions": 5,
            "correct_answers": 4,
            "score": 80,
            "current_score": 80,
            "average_score": 80,
            "timestamp": "2023-10-01T12:00:00Z",
            "question_details": [
              {
                "question": "Điều gì là nguyên nhân chính gây ra sốc phản vệ?",
                "options": [
                  "Viêm phổi",
                  "Phản ứng dị ứng nghiêm trọng",
                  "Nhiễm trùng huyết",
                  "Suy tim"
                ],
                "correct_answer": "Phản ứng dị ứng nghiêm trọng",
                "user_answer": "Phản ứng dị ứng nghiêm trọng",
                "is_correct": true
              },
              {
                "question": "Loại thuốc nào thường được sử dụng đầu tiên trong trường hợp ngừng tim?",
                "options": [
                  "Adrenaline",
                  "Atropine",
                  "Amiodarone",
                  "Lidocaine"
                ],
                "correct_answer": "Adrenaline",
                "user_answer": "Adrenaline",
                "is_correct": true
              }
            ]
          }
        ]
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$match": {
                  "questions": { "$exists": true }
                }
              },
              {
                "$addFields": {
                  "total_questions": { "$size": "$questions" },
                  "correct_answers": {
                    "$size": {
                      "$filter": {
                        "input": "$questions",
                        "as": "question",
                        "cond": {
                          "$eq": [
                            "$$question.user_answer",
                            "$$question.correct_answer"
                          ]
                        }
                      }
                    }
                  },
                  "question_details": {
                    "$map": {
                      "input": "$questions",
                      "as": "question",
                      "in": {
                        "question": "$$question.question",
                        "options": "$$question.options",
                        "correct_answer": "$$question.correct_answer",
                        "user_answer": "$$question.user_answer",
                        "is_correct": {
                          "$eq": [
                            "$$question.user_answer",
                            "$$question.correct_answer"
                          ]
                        }
                      }
                    }
                  }
                }
              },
              {
                "$addFields": {
                  "current_score": {
                    "$multiply": [
                      { "$divide": ["$correct_answers", "$total_questions"] },
                      100
                    ]
                  }
                }
              },
              {
                "$lookup": {
                  "from": "test_results",
                  "localField": "attempt_id",
                  "foreignField": "attempt_id",
                  "as": "previous_attempts"
                }
              },
              {
                "$addFields": {
                  "average_score": {
                    "$cond": {
                      "if": { "$gt": [{ "$size": "$previous_attempts" }, 0] },
                      "then": {
                        "$divide": [
                          {
                            "$sum": {
                              "$map": {
                                "input": "$previous_attempts",
                                "as": "attempt",
                                "in": "$$attempt.current_score"
                              }
                            }
                          },
                          { "$size": "$previous_attempts" }
                        ]
                      },
                      "else": "$current_score"
                    }
                  }
                }
              },
              {
                "$project": {
                  "_id": 1,
                  "attempt_id": 1,
                  "total_questions": 1,
                  "correct_answers": 1,
                  "score": 1,
                  "current_score": 1,
                  "average_score": 1,
                  "timestamp": 1,
                  "question_details": 1
                }
              },
              {
                "$merge": {
                  "into": "test_results",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Pipeline for calculating and storing test results with current and average scores.",
            "data_input_from_node": "test_attempts",
            "data_output_to_node": "test_results"
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "PhucHwa System",
        "author": "LOC",
        "version": "2.0",
        "year": "2025"
      }
    }
  },

  {
    "_id": "survey_attempts",
    "public": {
      "node_data": {
        "jsonSchema": {
          "title": "SurveyAttemptData",
          "type": "object",
          "properties": {
            "_id": { "type": "string" },
            "elderly_id": { "type": "string" },
            "attempt_id": { "type": "string" },
            "questions": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "question": { "type": "string" },
                  "answer": { "type": "string" }
                }
              }
            },
            "verified": { "type": "boolean" },
            "timestamp": { "type": "string", "format": "date-time" }
          },
          "required": [
            "_id",
            "elderly_id",
            "attempt_id",
            "questions",
            "verified",
            "timestamp"
          ],
          "additionalProperties": false
        },
        "jsonSample": [
          {
            "_id": "attempt_001",
            "elderly_id": "elderly_001",
            "attempt_id": "ATM123456",
            "questions": [
              {
                "question": "How are you feeling today?",
                "answer": "Good"
              },
              {
                "question": "Have you taken your medication?",
                "answer": "Yes"
              }
            ],
            "verified": true,
            "timestamp": "2023-10-01T12:00:00Z"
          }
        ]
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$match": {
                  "verified": true
                }
              },
              {
                "$merge": {
                  "into": "survey_attempts",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Pipeline for updating survey attempts.",
            "data_input_from_node": "elderlies",
            "data_output_to_node": "matching"
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "PhucHwa System",
        "author": "LOC",
        "version": "2.0",
        "year": "2025"
      }
    }
  },

  {
    "_id": "service_logs",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "title": "ServiceLogData",
          "type": "object",
          "properties": {
            "_id": { "type": "string" },
            "nurse_id": {
              "type": "string",
              "description": "ID của y tá chăm sóc (tham chiếu đến collection nurses)."
            },
            "elderly_id": {
              "type": "string",
              "description": "ID của người cao tuổi được chăm sóc (tham chiếu đến collection elderlies)."
            },
            "start_time": {
              "type": "string",
              "format": "date-time",
              "description": "Thời gian bắt đầu buổi chăm sóc."
            },
            "end_time": {
              "type": "string",
              "format": "date-time",
              "description": "Thời gian kết thúc buổi chăm sóc."
            },
            "location": {
              "type": "string",
              "description": "Địa chỉ hoặc khu vực chăm sóc."
            },
            "tasks_performed": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Danh sách các công việc đã thực hiện."
            },
            "vital_signs": {
              "type": "object",
              "properties": {
                "blood_pressure_systolic": {
                  "type": "number",
                  "description": "Huyết áp tâm thu (mmHg)."
                },
                "blood_pressure_diastolic": {
                  "type": "number",
                  "description": "Huyết áp tâm trương (mmHg)."
                },
                "pulse": {
                  "type": "number",
                  "description": "Nhịp tim (lần/phút)."
                },
                "respiratory_rate": {
                  "type": "number",
                  "description": "Nhịp thở (lần/phút)."
                },
                "temperature": {
                  "type": "number",
                  "description": "Nhiệt độ cơ thể (°C)."
                },
                "oxygen_saturation": {
                  "type": "number",
                  "description": "SpO2 – Nồng độ Oxy trong máu (%)."
                },
                "weight": {
                  "type": "number",
                  "nullable": true,
                  "description": "Cân nặng (kg)."
                },
                "height": {
                  "type": "number",
                  "nullable": true,
                  "description": "Chiều cao (cm)."
                }
              },
              "required": [
                "blood_pressure_systolic",
                "blood_pressure_diastolic",
                "pulse",
                "respiratory_rate",
                "temperature",
                "oxygen_saturation"
              ],
              "additionalProperties": false
            },
            "created_at": {
              "type": "string",
              "format": "date-time",
              "description": "Thời gian tạo log."
            },
            "updated_at": {
              "type": "string",
              "format": "date-time",
              "description": "Lần chỉnh sửa cuối."
            }
          },
          "required": [
            "_id",
            "nurse_id",
            "elderly_id",
            "start_time",
            "end_time",
            "location",
            "tasks_performed",
            "vital_signs",
            "created_at",
            "updated_at"
          ],
          "additionalProperties": false
        },
        "jsonSample": [
          {
            "_id": "log_001",
            "nurse_id": "nurse_001",
            "elderly_id": "elderly_001",
            "start_time": "2023-10-01T08:00:00Z",
            "end_time": "2023-10-01T10:00:00Z",
            "location": "Quận 1, TP.HCM",
            "tasks_performed": [
              "Đo huyết áp",
              "Kiểm tra nhịp tim",
              "Hỗ trợ vận động"
            ],
            "vital_signs": {
              "blood_pressure_systolic": 120,
              "blood_pressure_diastolic": 80,
              "pulse": 72,
              "respiratory_rate": 16,
              "temperature": 36.8,
              "oxygen_saturation": 98,
              "weight": 65.5,
              "height": 160
            },
            "created_at": "2023-10-01T12:00:00Z",
            "updated_at": "2023-10-01T12:00:00Z"
          }
        ]
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$match": {
                  "nurse_id": { "$exists": true },
                  "elderly_id": { "$exists": true }
                }
              },
              {
                "$addFields": {
                  "total_care_hours": {
                    "$divide": [
                      { "$subtract": ["$end_time", "$start_time"] },
                      3600000
                    ]
                  }
                }
              },
              {
                "$merge": {
                  "into": "service_logs",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Pipeline for calculating total care hours and updating service logs.",
            "data_input_from_node": ["nurses", "elderlies"],
            "data_output_to_node": "service_logs"
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "PhucHwa Systemt",
        "author": "LOC",
        "version": "2.0",
        "year": "2025"
      }
    }
  },

  {
    "_id": "contracts",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "title": "ContractData",
          "type": "object",
          "properties": {
            "_id": {
              "type": "string",
              "description": "ID duy nhất của tài liệu do MongoDB tạo."
            },
            "matching_id": {
              "type": "string",
              "description": "ID của matching (tham chiếu đến collection matching)."
            },
            "elderly_id": {
              "type": "string",
              "description": "ID của elderly (tham chiếu đến collection elderlies)."
            },
            "nurse_id": {
              "type": "string",
              "description": "ID của nurse (tham chiếu đến collection nurses)."
            },
            "contract_hash": {
              "type": "string",
              "description": "Hash toàn bộ terms (sử dụng thuật toán SHA-256 hoặc tương đương)."
            },
            "signed_at": {
              "type": "string",
              "format": "date-time",
              "description": "Thời gian ký hợp đồng."
            },
            "status": {
              "type": "string",
              "enum": ["pending", "active", "violated", "terminated"],
              "description": "Trạng thái của hợp đồng."
            },
            "signed_by_elderly": {
              "type": "string",
              "format": "date-time",
              "nullable": true,
              "description": "Thời điểm elderly ký hợp đồng (hoặc null nếu chưa ký)."
            },
            "signed_by_nurse": {
              "type": "string",
              "format": "date-time",
              "nullable": true,
              "description": "Thời điểm nurse ký hợp đồng (hoặc null nếu chưa ký)."
            },
            "elderly_signature": {
              "type": "string",
              "nullable": true,
              "description": "Chữ ký số của elderly (ECDSA ký lên contract_hash)."
            },
            "nurse_signature": {
              "type": "string",
              "nullable": true,
              "description": "Chữ ký số của nurse (truy xuất từ collection cards)."
            },
            "effective_date": {
              "type": "string",
              "format": "date-time",
              "description": "Ngày hợp đồng bắt đầu hiệu lực (có thể khác ngày ký)."
            },
            "expiry_date": {
              "type": "string",
              "format": "date-time",
              "nullable": true,
              "description": "Ngày kết thúc hợp đồng."
            },
            "created_by": {
              "type": "string",
              "default": "system",
              "description": "Ai tạo hợp đồng này? (thường là hệ thống)."
            },
            "last_modified_at": {
              "type": "string",
              "format": "date-time",
              "description": "Thời gian cập nhật lần cuối."
            },
            "history_logs": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "action": { "type": "string" },
                  "modified_by": { "type": "string" },
                  "timestamp": { "type": "string", "format": "date-time" }
                },
                "required": ["action", "modified_by", "timestamp"],
                "additionalProperties": false
              },
              "description": "Lịch sử thay đổi trạng thái hợp đồng."
            },
            "payment_details": {
              "type": "object",
              "properties": {
                "service_level": {
                  "type": "string",
                  "enum": ["basic", "standard", "premium"],
                  "description": "Mức dịch vụ: basic (cơ bản), standard (tiêu chuẩn), premium (cao cấp)."
                },
                "price_per_hour": {
                  "type": "number",
                  "description": "Giá elderly trả cho mỗi giờ (VND/giờ)."
                },
                "total_hours_booked": {
                  "type": "integer",
                  "description": "Tổng số giờ được booking trong hợp đồng."
                },
                "deposit_amount": {
                  "type": "number",
                  "description": "Số tiền cọc elderly phải thanh toán trước (50% tổng giá trị hợp đồng)."
                },
                "remaining_payment": {
                  "type": "number",
                  "description": "Số tiền còn lại elderly phải thanh toán sau khi hoàn thành công việc (50% tổng giá trị hợp đồng)."
                },
                "nurse_share_percentage": {
                  "type": "number",
                  "description": "Phần trăm doanh thu nurse nhận được (%)."
                },
                "platform_share_percentage": {
                  "type": "number",
                  "description": "Phần trăm doanh thu platform giữ lại (%)."
                },
                "nurse_total_earnings": {
                  "type": "number",
                  "description": "Tổng số tiền nurse nhận được sau khi hoàn thành công việc."
                },
                "platform_total_earnings": {
                  "type": "number",
                  "description": "Tổng số tiền platform giữ lại."
                }
              },
              "required": [
                "service_level",
                "price_per_hour",
                "total_hours_booked",
                "deposit_amount",
                "remaining_payment",
                "nurse_share_percentage",
                "platform_share_percentage",
                "nurse_total_earnings",
                "platform_total_earnings"
              ],
              "description": "Chi tiết thanh toán và phân chia doanh thu."
            },
            "terms": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Các điều khoản trong hợp đồng."
            }
          },
          "required": [
            "_id",
            "matching_id",
            "elderly_id",
            "nurse_id",
            "contract_hash",
            "signed_at",
            "status",
            "effective_date",
            "created_by",
            "last_modified_at",
            "payment_details",
            "terms"
          ],
          "additionalProperties": false
        },
        "jsonSample": [
          {
            "_id": "contract_001",
            "matching_id": "matching_123",
            "elderly_id": "elderly_456",
            "nurse_id": "nurse_789",
            "contract_hash": "a1b2c3d4e5f6...",
            "signed_at": "2025-04-26T09:00:00Z",
            "status": "active",
            "signed_by_elderly": "2025-04-26T09:05:00Z",
            "signed_by_nurse": "2025-04-26T09:10:00Z",
            "elderly_signature": "MEUCIQD...base64-encoded-signature...",
            "nurse_signature": "MEYCIQClmjgP0xIDTkGzJ3knZFbs6p5X... (rút gọn)",
            "effective_date": "2025-04-27T00:00:00Z",
            "expiry_date": "2026-04-27T00:00:00Z",
            "created_by": "system",
            "last_modified_at": "2025-04-26T09:15:00Z",
            "history_logs": [
              {
                "action": "created",
                "modified_by": "system",
                "timestamp": "2025-04-26T09:00:00Z"
              },
              {
                "action": "elderly_signed",
                "modified_by": "elderly_456",
                "timestamp": "2025-04-26T09:05:00Z"
              },
              {
                "action": "nurse_signed",
                "modified_by": "nurse_789",
                "timestamp": "2025-04-26T09:10:00Z"
              },
              {
                "action": "activated",
                "modified_by": "system",
                "timestamp": "2025-04-26T09:15:00Z"
              }
            ],
            "payment_details": {
              "service_level": "basic",
              "price_per_hour": 150000,
              "total_hours_booked": 10,
              "deposit_amount": 750000,
              "remaining_payment": 750000,
              "nurse_share_percentage": 75,
              "platform_share_percentage": 25,
              "nurse_total_earnings": 1125000,
              "platform_total_earnings": 375000
            },
            "terms": [
              "Elderly phải thanh toán trước 50% giá trị hợp đồng.",
              "Nurse sẽ nhận 75% doanh thu, platform giữ 25%.",
              "Hợp đồng có hiệu lực từ 2025-04-27 đến 2026-04-27."
            ]
          }
        ]
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$match": {
                  "status": "pending"
                }
              },
              {
                "$lookup": {
                  "from": "cards",
                  "localField": "nurse_id",
                  "foreignField": "user_id",
                  "as": "nurse_card_info"
                }
              },
              {
                "$addFields": {
                  "nurse_signature": {
                    "$arrayElemAt": ["$nurse_card_info.signature", 0]
                  },
                  "elderly_signature": {
                    "$concat": ["$elderly_id", "$contract_hash"]
                  }
                }
              },
              {
                "$addFields": {
                  "signed_by_elderly": {
                    "$cond": {
                      "if": { "$ne": ["$elderly_signature", null] },
                      "then": "$$NOW",
                      "else": null
                    }
                  },
                  "signed_by_nurse": {
                    "$cond": {
                      "if": { "$ne": ["$nurse_signature", null] },
                      "then": "$$NOW",
                      "else": null
                    }
                  }
                }
              },
              {
                "$match": {
                  "signed_by_elderly": { "$exists": true },
                  "signed_by_nurse": { "$exists": true }
                }
              },
              {
                "$addFields": {
                  "status": "active",
                  "last_modified_at": "$$NOW"
                }
              },
              {
                "$addFields": {
                  "history_logs": {
                    "$concatArrays": [
                      "$history_logs",
                      [
                        {
                          "action": "contract_status_updated_to_active",
                          "modified_by": "system",
                          "timestamp": "$$NOW"
                        }
                      ]
                    ]
                  }
                }
              },
              {
                "$merge": {
                  "into": "contracts",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Pipeline for activating contracts when both parties have signed.",
            "data_input_from_node": ["matching", "cards"],
            "data_output_to_node": "contracts"
          },
          {
            "pipeline": [
              {
                "$match": {
                  "status": { "$in": ["pending", "active"] }
                }
              },
              {
                "$lookup": {
                  "from": "transactions",
                  "localField": "payment_details.transaction_id",
                  "foreignField": "transaction_id",
                  "as": "transaction_details"
                }
              },
              {
                "$addFields": {
                  "is_payment_completed": {
                    "$cond": {
                      "if": {
                        "$eq": ["$transaction_details.status", "completed"]
                      },
                      "then": true,
                      "else": false
                    }
                  }
                }
              },
              {
                "$lookup": {
                  "from": "disputes",
                  "localField": "_id",
                  "foreignField": "contract_id",
                  "as": "dispute_details"
                }
              },
              {
                "$addFields": {
                  "has_violation": {
                    "$cond": {
                      "if": { "$gt": [{ "$size": "$dispute_details" }, 0] },
                      "then": true,
                      "else": false
                    }
                  }
                }
              },
              {
                "$addFields": {
                  "status": {
                    "$switch": {
                      "branches": [
                        {
                          "case": {
                            "$and": [
                              "$has_violation",
                              { "$ne": ["$status", "violated"] }
                            ]
                          },
                          "then": "violated"
                        },
                        {
                          "case": {
                            "$and": [
                              "$is_payment_completed",
                              { "$eq": ["$status", "pending"] }
                            ]
                          },
                          "then": "active"
                        }
                      ],
                      "default": "$status"
                    }
                  }
                }
              },
              {
                "$merge": {
                  "into": "contracts",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Pipeline for monitoring contracts, detecting violations, and updating contract status based on payment and disputes.",
            "data_input_from_node": ["transactions", "disputes"],
            "data_output_to_node": "contracts"
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "PhucHwa System",
        "author": "LOC",
        "version": "2.2",
        "year": "2025"
      }
    }
  },

  {
    "_id": "matching",
    "public": {
      "node_data": {
        "jsonSchema": {
          "title": "MatchingData",
          "type": "object",
          "properties": {
            "_id": { "type": "string" },
            "nurse_id": { "type": "string" },
            "elderly_id": { "type": "string" },
            "service_level": {
              "type": "string",
              "enum": ["basic", "standard", "premium"],
              "description": "Mức dịch vụ: basic (cơ bản), standard (tiêu chuẩn), premium (cao cấp)."
            },
            "booking_time": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "start_time": { "type": "string", "format": "date-time" },
                  "end_time": { "type": "string", "format": "date-time" }
                }
              },
              "description": "Khung giờ booking được chọn bởi elderly."
            },
            "contract_status": {
              "type": "object",
              "properties": {
                "elderly_signature": {
                  "type": "string",
                  "nullable": true,
                  "description": "Chữ ký điện tử của elderly."
                },
                "nurse_signature": {
                  "type": "string",
                  "nullable": true,
                  "description": "Chữ ký điện tử của nurse."
                },
                "contract_hash": {
                  "type": "string",
                  "nullable": true,
                  "description": "Hash của hợp đồng thông minh."
                },
                "is_signed": {
                  "type": "boolean",
                  "default": false,
                  "description": "Trạng thái ký hợp đồng."
                }
              },
              "required": [
                "elderly_signature",
                "nurse_signature",
                "contract_hash",
                "is_signed"
              ],
              "additionalProperties": false
            },
            "violation_report": {
              "type": "object",
              "nullable": true,
              "properties": {
                "reported_by": { "type": "string" },
                "reason": { "type": "string" },
                "timestamp": { "type": "string", "format": "date-time" }
              },
              "description": "Báo cáo vi phạm hợp đồng."
            },
            "isMatched": { "type": "boolean", "default": false },
            "matchedAt": { "type": "string", "format": "date-time" },
            "resetAt": { "type": "string", "format": "date-time" }
          },
          "required": [
            "_id",
            "nurse_id",
            "elderly_id",
            "service_level",
            "isMatched",
            "resetAt",
            "booking_time",
            "contract_status"
          ],
          "additionalProperties": false
        },
        "jsonSample": [
          {
            "_id": "match_001",
            "nurse_id": "nurse_001",
            "elderly_id": "elderly_001",
            "service_level": "basic",
            "isMatched": true,
            "matchedAt": "2023-10-01T12:00:00Z",
            "resetAt": "2023-10-02T08:00:00Z"
          }
        ]
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$match": {
                  "isMatched": false
                }
              },
              {
                "$addFields": {
                  "contract_status": {
                    "contract_hash": {
                      "$arrayElemAt": ["$contract_details.contract_hash", 0]
                    },
                    "is_signed": {
                      "$cond": {
                        "if": {
                          "$and": [
                            {
                              "$ne": [
                                {
                                  "$arrayElemAt": [
                                    "$contract_details.signed_by_elderly",
                                    0
                                  ]
                                },
                                null
                              ]
                            },
                            {
                              "$ne": [
                                {
                                  "$arrayElemAt": [
                                    "$contract_details.signed_by_nurse",
                                    0
                                  ]
                                },
                                null
                              ]
                            }
                          ]
                        },
                        "then": true,
                        "else": false
                      }
                    }
                  }
                }
              },
              {
                "$match": {
                  "contract_status.is_signed": true
                }
              },
              {
                "$lookup": {
                  "from": "nurses",
                  "localField": "nurse_id",
                  "foreignField": "_id",
                  "as": "availableNurses"
                }
              },
              {
                "$lookup": {
                  "from": "elderlies",
                  "localField": "elderly_id",
                  "foreignField": "_id",
                  "as": "availableElderlies"
                }
              },
              {
                "$addFields": {
                  "matchedPairs": {
                    "$map": {
                      "input": "$availableElderlies",
                      "as": "elderly",
                      "in": {
                        "elderly_id": "$$elderly._id",
                        "nurse_id": {
                          "$arrayElemAt": [
                            {
                              "$filter": {
                                "input": "$availableNurses",
                                "as": "nurse",
                                "cond": {
                                  "$and": [
                                    {
                                      "$eq": [
                                        "$$nurse.isAvailableForMatching",
                                        true
                                      ]
                                    },
                                    {
                                      "$lte": ["$$nurse.distanceToElderly", 10]
                                    }
                                  ]
                                }
                              }
                            },
                            0
                          ]
                        }
                      }
                    }
                  }
                }
              },
              {
                "$lookup": {
                  "from": "test_results",
                  "localField": "nurse_id",
                  "foreignField": "attempt_id",
                  "as": "nurse_test_results"
                }
              },
              {
                "$addFields": {
                  "average_score": {
                    "$arrayElemAt": ["$nurse_test_results.average_score", 0]
                  }
                }
              },
              {
                "$lookup": {
                  "from": "service_logs",
                  "localField": "nurse_id",
                  "foreignField": "nurse_id",
                  "as": "nurse_service_logs"
                }
              },
              {
                "$addFields": {
                  "total_care_hours": {
                    "$sum": {
                      "$map": {
                        "input": "$nurse_service_logs",
                        "as": "log",
                        "in": {
                          "$divide": [
                            {
                              "$subtract": [
                                "$$log.end_time",
                                "$$log.start_time"
                              ]
                            },
                            3600000
                          ]
                        }
                      }
                    }
                  }
                }
              },
              {
                "$match": {
                  "nurse_score": { "$gt": 70 },
                  "total_care_hours": { "$lt": 56 }
                }
              },
              {
                "$lookup": {
                  "from": "nurses",
                  "localField": "nurse_id",
                  "foreignField": "_id",
                  "as": "availableNurses"
                }
              },
              {
                "$lookup": {
                  "from": "elderlies",
                  "localField": "elderly_id",
                  "foreignField": "_id",
                  "as": "availableElderlies"
                }
              },
              {
                "$addFields": {
                  "matchedPairs": {
                    "$map": {
                      "input": "$availableElderlies",
                      "as": "elderly",
                      "in": {
                        "elderly_id": "$$elderly._id",
                        "nurse_id": {
                          "$arrayElemAt": [
                            {
                              "$filter": {
                                "input": "$availableNurses",
                                "as": "nurse",
                                "cond": {
                                  "$and": [
                                    {
                                      "$eq": [
                                        "$$nurse.isAvailableForMatching",
                                        true
                                      ]
                                    },
                                    {
                                      "$lte": ["$$nurse.distanceToElderly", 10]
                                    }
                                  ]
                                }
                              }
                            },
                            0
                          ]
                        }
                      }
                    }
                  }
                }
              },
              {
                "$merge": {
                  "into": "matching",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Pipeline for updating matching status with basic service level conditions.",
            "data_input_from_node": [
              "test_attempts",
              "survey_attempts",
              "nurses",
              "elderlies",
              "test_results",
              "service_logs"
            ],
            "data_output_to_node": "transactions"
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "PhucHwa System",
        "author": "LOC",
        "version": "2.0",
        "year": "2025"
      }
    }
  },

  {
    "_id": "feedbacks",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "title": "FeedbackData",
          "type": "object",
          "properties": {
            "_id": { "type": "string" },
            "from_user_id": {
              "type": "string",
              "description": "ID của người gửi feedback (elderly)."
            },
            "to_user_id": {
              "type": "string",
              "description": "ID của người nhận feedback (nurse)."
            },
            "service_id": {
              "type": "string",
              "description": "ID của dịch vụ/chăm sóc liên quan."
            },
            "rating": {
              "type": "number",
              "minimum": 1,
              "maximum": 5,
              "description": "Điểm đánh giá từ 1–5 sao."
            },
            "title": {
              "type": "string",
              "nullable": true,
              "description": "Tiêu đề ngắn (tuỳ chọn)."
            },
            "comment": {
              "type": "string",
              "description": "Nội dung nhận xét."
            },
            "createdAt": {
              "type": "string",
              "format": "date-time",
              "description": "Thời gian gửi feedback."
            },
            "is_verified": {
              "type": "boolean",
              "default": false,
              "description": "Feedback có được xác minh là hợp lệ không."
            },
            "report_flag": {
              "type": "boolean",
              "default": false,
              "description": "Có bị báo cáo là giả mạo hoặc không trung thực không."
            },
            "report_reason": {
              "type": "string",
              "nullable": true,
              "description": "Lý do nếu bị report."
            },
            "service_level": {
              "type": "string",
              "enum": ["basic", "standard", "premium"],
              "description": "Mức dịch vụ liên quan đến feedback."
            },
            "ai_sentiment_analysis": {
              "type": "string",
              "enum": ["positive", "negative", "neutral", "pending"],
              "description": "Kết quả phân tích cảm xúc từ model AI."
            }
          },
          "required": [
            "_id",
            "from_user_id",
            "to_user_id",
            "service_id",
            "rating",
            "comment",
            "createdAt",
            "is_verified",
            "report_flag",
            "service_level"
          ],
          "additionalProperties": false
        },
        "jsonSample": [
          {
            "_id": "feedback_001",
            "from_user_id": "elderly_001",
            "to_user_id": "nurse_001",
            "service_id": "service_001",
            "rating": 4,
            "title": "Chăm sóc tốt",
            "comment": "Y tá rất nhiệt tình và chu đáo.",
            "createdAt": "2023-10-01T12:00:00Z",
            "is_verified": true,
            "report_flag": false,
            "report_reason": null,
            "service_level": "standard",
            "ai_sentiment_analysis": "positive"
          }
        ]
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$match": {
                  "from_user_id": { "$exists": true },
                  "to_user_id": { "$exists": true },
                  "service_id": { "$exists": true }
                }
              },
              {
                "$addFields": {
                  "createdAt": "$$NOW",
                  "is_verified": false,
                  "report_flag": false,
                  "ai_sentiment_analysis": "pending"
                }
              },
              {
                "$lookup": {
                  "from": "matching",
                  "localField": "service_id",
                  "foreignField": "_id",
                  "as": "service_matching"
                }
              },
              {
                "$addFields": {
                  "service_level": {
                    "$arrayElemAt": ["$service_matching.service_level", 0]
                  }
                }
              },
              {
                "$project": {
                  "_id": 1,
                  "from_user_id": 1,
                  "to_user_id": 1,
                  "service_id": 1,
                  "rating": 1,
                  "title": 1,
                  "comment": 1,
                  "createdAt": 1,
                  "is_verified": 1,
                  "report_flag": 1,
                  "report_reason": 1,
                  "service_level": 1,
                  "ai_sentiment_analysis": 1
                }
              },
              {
                "$merge": {
                  "into": "feedbacks",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Pipeline for storing and processing feedbacks with AI sentiment analysis.",
            "data_input_from_node": ["elderlies", "nurses", "matching"],
            "data_output_to_node": "feedbacks"
          },
          {
            "pipeline": [
              {
                "$match": {
                  "ai_sentiment_analysis": "pending"
                }
              },
              {
                "$lookup": {
                  "from": "feedbacks",
                  "localField": "_id",
                  "foreignField": "_id",
                  "as": "current_feedback"
                }
              },
              {
                "$addFields": {
                  "comment_to_analyze": {
                    "$arrayElemAt": ["$current_feedback.comment", 0]
                  }
                }
              },
              {
                "$lookup": {
                  "from": "ai_sentiment_results",
                  "let": { "comment": "$comment_to_analyze" },
                  "pipeline": [
                    {
                      "$addFields": {
                        "sentiment": {
                          "$function": {
                            "body": "function(comment) { return analyzeSentiment(comment); }",
                            "args": ["$$comment"],
                            "lang": "js"
                          }
                        }
                      }
                    }
                  ],
                  "as": "ai_result"
                }
              },
              {
                "$addFields": {
                  "ai_sentiment_analysis": {
                    "$arrayElemAt": ["$ai_result.sentiment", 0]
                  }
                }
              },
              {
                "$merge": {
                  "into": "feedbacks",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Pipeline for sending comments to AI endpoint and updating sentiment analysis results.",
            "data_input_from_node": "feedbacks",
            "data_output_to_node": "feedbacks"
          },
          {
            "pipeline": [
              {
                "$match": {
                  "ai_sentiment_analysis": "pending"
                }
              },
              {
                "$addFields": {
                  "api_endpoint": "/add_comment",
                  "api_method": "POST",
                  "api_payload": {
                    "comment": "$comment"
                  }
                }
              },
              {
                "$lookup": {
                  "from": "http_requests",
                  "let": {
                    "endpoint": "$api_endpoint",
                    "method": "$api_method",
                    "payload": "$api_payload"
                  },
                  "pipeline": [
                    {
                      "$addFields": {
                        "response": {
                          "$function": {
                            "body": "function(endpoint, method, payload) { return sendHttpRequest(endpoint, method, payload); }",
                            "args": ["$$endpoint", "$$method", "$$payload"],
                            "lang": "js"
                          }
                        }
                      }
                    }
                  ],
                  "as": "api_response"
                }
              },
              {
                "$addFields": {
                  "ai_sentiment_analysis": {
                    "$arrayElemAt": ["$api_response.response.sentiment", 0]
                  }
                }
              },
              {
                "$merge": {
                  "into": "feedbacks",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Pipeline for sending comments to /add_comment endpoint and updating sentiment analysis results.",
            "data_input_from_node": "feedbacks",
            "data_output_to_node": "feedbacks"
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "PhucHwa System",
        "author": "LOC",
        "version": "2.0",
        "year": "2025"
      }
    }
  },

  {
    "_id": "transactions",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "title": "TransactionData",
          "type": "object",
          "properties": {
            "_id": {
              "bsonType": "objectId",
              "description": "ID duy nhất của tài liệu do MongoDB tự động sinh."
            },
            "transaction_id": {
              "type": "string",
              "description": "ID giao dịch duy nhất (UUIDv4)."
            },
            "elderly_id": {
              "type": "string",
              "description": "ID elderly thực hiện thanh toán (tham chiếu đến collection elderlies)."
            },
            "nurse_id": {
              "type": "string",
              "description": "ID nurse nhận thanh toán (tham chiếu đến collection nurses và cards)."
            },
            "amount": {
              "type": "number",
              "minimum": 0,
              "description": "Số tiền thanh toán (ví dụ: VND hoặc Token unit)."
            },
            "currency": {
              "type": "string",
              "enum": ["VND", "ETH", "USDT", "PlatformToken"],
              "description": "Loại tiền tệ sử dụng trong giao dịch."
            },
            "service_type": {
              "type": "string",
              "enum": ["basic", "standard", "premium"],
              "description": "Loại dịch vụ liên quan đến giao dịch."
            },
            "platform_fee": {
              "type": "number",
              "minimum": 0,
              "description": "Phí nền tảng (số tiền trừ ra từ tổng số tiền)."
            },
            "nurse_receive_amount": {
              "type": "number",
              "minimum": 0,
              "description": "Số tiền thực tế nurse nhận sau khi trừ phí nền tảng."
            },
            "status": {
              "type": "string",
              "enum": ["pending", "completed", "failed", "cancelled"],
              "description": "Trạng thái giao dịch."
            },
            "payment_method": {
              "type": "string",
              "enum": ["bank_transfer"],
              "description": "Phương thức thanh toán (không sử dụng wallet_balance)."
            },
            "created_at": {
              "type": "string",
              "format": "date-time",
              "description": "Thời gian tạo giao dịch."
            },
            "updated_at": {
              "type": "string",
              "format": "date-time",
              "description": "Thời gian cập nhật giao dịch."
            },
            "note": {
              "type": "string",
              "nullable": true,
              "description": "Ghi chú giao dịch (ví dụ: lý do refund, lý do cancel)."
            },
            "withdraw_request_id": {
              "type": "string",
              "nullable": true,
              "description": "ID rút tiền liên quan (nếu có, tham chiếu đến collection withdraw_requests)."
            }
          },
          "required": [
            "_id",
            "transaction_id",
            "elderly_id",
            "nurse_id",
            "amount",
            "currency",
            "service_type",
            "platform_fee",
            "nurse_receive_amount",
            "status",
            "payment_method",
            "created_at",
            "updated_at"
          ],
          "additionalProperties": false
        },
        "jsonSample": [
          {
            "_id": "653f8b2e1c9d440000a1b2c3",
            "transaction_id": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
            "elderly_id": "elderly_123",
            "nurse_id": "nurse_456",
            "amount": 1500000,
            "currency": "VND",
            "service_type": "standard",
            "platform_fee": 300000,
            "nurse_receive_amount": 1200000,
            "status": "completed",
            "payment_method": "bank_transfer",
            "created_at": "2023-10-01T12:00:00Z",
            "updated_at": "2023-10-01T12:05:00Z",
            "note": "Thanh toán cho dịch vụ chăm sóc cơ bản.",
            "withdraw_request_id": null
          }
        ]
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$match": {
                  "status": "pending"
                }
              },
              {
                "$lookup": {
                  "from": "cards",
                  "localField": "elderly_id",
                  "foreignField": "user_id",
                  "as": "elderly_wallet"
                }
              },
              {
                "$lookup": {
                  "from": "cards",
                  "localField": "nurse_id",
                  "foreignField": "user_id",
                  "as": "nurse_wallet"
                }
              },
              {
                "$addFields": {
                  "elderly_balance": {
                    "$arrayElemAt": ["$elderly_wallet.balance", 0]
                  },
                  "nurse_balance": {
                    "$arrayElemAt": ["$nurse_wallet.balance", 0]
                  }
                }
              },
              {
                "$match": {
                  "elderly_balance": { "$gte": "$amount" }
                }
              },
              {
                "$addFields": {
                  "new_elderly_balance": {
                    "$subtract": ["$elderly_balance", "$amount"]
                  },
                  "new_nurse_balance": {
                    "$add": ["$nurse_balance", "$nurse_receive_amount"]
                  },
                  "platform_balance_increase": "$platform_fee",
                  "updated_at": {
                    "$dateToString": {
                      "format": "%Y-%m-%dT%H:%M:%SZ",
                      "date": "$$NOW"
                    }
                  }
                }
              },
              {
                "$merge": {
                  "into": "transactions",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              },
              {
                "$merge": {
                  "into": "cards",
                  "on": "user_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Pipeline for updating transactions.",
            "data_input_from_node": "pricing",
            "data_output_to_node": ""
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "PhucHwa System",
        "author": "LOC",
        "version": "2.0",
        "year": "2025"
      }
    }
  },

  {
    "_id": "disputes",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "title": "DisputeData",
          "type": "object",
          "properties": {
            "_id": {
              "bsonType": "objectId",
              "description": "ID duy nhất của tài liệu do MongoDB tự động sinh."
            },
            "dispute_id": {
              "type": "string",
              "description": "ID tranh chấp (UUID)."
            },
            "transaction_id": {
              "type": "string",
              "description": "ID giao dịch bị tranh chấp (tham chiếu đến collection transactions)."
            },
            "complainant_id": {
              "type": "string",
              "description": "ID người gửi khiếu nại (elderly hoặc nurse)."
            },
            "defendant_id": {
              "type": "string",
              "description": "ID người bị khiếu nại (elderly hoặc nurse)."
            },
            "reason": {
              "type": "string",
              "description": "Lý do tranh chấp."
            },
            "evidences": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Link hình ảnh, file bằng chứng."
            },
            "status": {
              "type": "string",
              "enum": ["open", "under_review", "resolved", "rejected"],
              "description": "Trạng thái tranh chấp."
            },
            "resolution": {
              "type": "string",
              "nullable": true,
              "description": "Cách xử lý (phạt tiền, refund, ban...)."
            },
            "created_at": {
              "type": "string",
              "format": "date-time",
              "description": "Thời gian tạo tranh chấp."
            },
            "resolved_at": {
              "type": "string",
              "format": "date-time",
              "nullable": true,
              "description": "Thời gian giải quyết tranh chấp."
            }
          },
          "required": [
            "_id",
            "dispute_id",
            "transaction_id",
            "complainant_id",
            "defendant_id",
            "reason",
            "status",
            "created_at"
          ],
          "additionalProperties": false
        },
        "jsonSample": [
          {
            "_id": "653f8b2e1c9d440000a1b2c3",
            "dispute_id": "d1e2f3g4-h5i6-j7k8-l9m0-n1o2p3q4r5s6",
            "transaction_id": "t1x2y3z4-a5b6-c7d8-e9f0-g1h2i3j4k5l6",
            "complainant_id": "elderly_123",
            "defendant_id": "nurse_456",
            "reason": "Nurse không thực hiện đúng cam kết chăm sóc.",
            "evidences": [
              "https://example.com/evidence1.jpg",
              "https://example.com/chat_log.txt"
            ],
            "status": "under_review",
            "resolution": null,
            "created_at": "2025-04-26T09:00:00Z",
            "resolved_at": null
          }
        ]
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$match": {
                  "status": { "$in": ["open", "under_review"] }
                }
              },
              {
                "$lookup": {
                  "from": "transactions",
                  "localField": "transaction_id",
                  "foreignField": "transaction_id",
                  "as": "transaction_details"
                }
              },
              {
                "$lookup": {
                  "from": "contracts",
                  "localField": "transaction_id",
                  "foreignField": "payment_details.transaction_id",
                  "as": "contract_details"
                }
              },
              {
                "$addFields": {
                  "transaction_details": {
                    "$arrayElemAt": ["$transaction_details", 0]
                  },
                  "contract_details": {
                    "$arrayElemAt": ["$contract_details", 0]
                  }
                }
              },
              {
                "$addFields": {
                  "penalty_fee": {
                    "$multiply": ["$transaction_details.amount", 0.1]
                  },
                  "freeze_balance": {
                    "$cond": {
                      "if": {
                        "$eq": [
                          "$defendant_id",
                          "$transaction_details.nurse_id"
                        ]
                      },
                      "then": "$transaction_details.nurse_receive_amount",
                      "else": 0
                    }
                  }
                }
              },
              {
                "$merge": {
                  "into": "disputes",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              },
              {
                "$merge": {
                  "into": "wallets",
                  "on": "user_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Pipeline for updating disputes.",
            "data_input_from_node": "contracts",
            "data_output_to_node": ""
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "PhucHwa System",
        "author": "LOC",
        "version": "2.2",
        "year": "2025"
      }
    }
  },

  {
    "_id": "pricing",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "title": "PriceData",
          "description": "Schema for the prices collection, containing pricing and service details.",
          "type": "object",
          "properties": {
            "_id": {
              "type": "string",
              "description": "ID duy nhất của tài liệu do MongoDB tạo."
            },
            "service_level": {
              "type": "string",
              "enum": ["basic", "standard", "premium"],
              "description": "Mức dịch vụ: basic (cơ bản), standard (tiêu chuẩn), premium (cao cấp)."
            },
            "price_range": {
              "type": "object",
              "properties": {
                "min": {
                  "type": "number",
                  "description": "Giá tối thiểu (VND/giờ)."
                },
                "max": {
                  "type": "number",
                  "description": "Giá tối đa (VND/giờ)."
                }
              },
              "required": ["min", "max"],
              "description": "Phạm vi giá cho dịch vụ."
            },
            "elderly_benefits": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Quyền lợi dành cho elderly (dịch vụ mà người cao tuổi được hưởng)."
            },
            "nurse_obligations": {
              "type": "object",
              "properties": {
                "committed_hours_per_week": {
                  "type": "integer",
                  "description": "Số giờ làm việc cam kết/tuần."
                },
                "response_time_commitment": {
                  "type": "string",
                  "enum": ["24h", "12h", "4h"],
                  "description": "Thời gian phản hồi yêu cầu (trong 24h, 12h hoặc 4h)."
                },
                "daily_reports": {
                  "type": "integer",
                  "description": "Số lần báo cáo tình trạng/ngày."
                },
                "certifications_required": {
                  "type": "array",
                  "items": { "type": "string" },
                  "description": "Chứng chỉ bắt buộc đối với nurse."
                },
                "training_frequency": {
                  "type": "string",
                  "nullable": true,
                  "description": "Tần suất đào tạo định kỳ (ví dụ: hàng quý)."
                },
                "quality_supervision_frequency": {
                  "type": "string",
                  "nullable": true,
                  "description": "Tần suất kiểm tra chất lượng (ví dụ: hàng tháng)."
                }
              },
              "required": [
                "committed_hours_per_week",
                "response_time_commitment",
                "daily_reports",
                "certifications_required"
              ],
              "description": "Nghĩa vụ của nurse (cam kết thực hiện)."
            }
          },
          "required": [
            "_id",
            "service_level",
            "price_range",
            "elderly_benefits",
            "nurse_obligations"
          ],
          "additionalProperties": false
        },
        "jsonSample": [
          {
            "_id": "price_basic",
            "service_level": "basic",
            "price_range": { "min": 120000, "max": 150000 },
            "elderly_benefits": [
              "Chăm sóc cơ bản (ăn uống, đi lại, vệ sinh cá nhân)",
              "Nhắc thuốc đúng giờ",
              "Báo cáo hằng ngày cho người thân"
            ],
            "nurse_obligations": {
              "committed_hours_per_week": 20,
              "response_time_commitment": "24h",
              "daily_reports": 1,
              "certifications_required": ["chăm sóc cơ bản"]
            }
          },
          {
            "_id": "price_standard",
            "service_level": "standard",
            "price_range": { "min": 180000, "max": 220000 },
            "elderly_benefits": [
              "Tất cả quyền lợi Basic",
              "Vật lý trị liệu nhẹ",
              "Theo dõi dấu hiệu sinh tồn (huyết áp, nhịp tim)",
              "Cập nhật sức khỏe định kỳ"
            ],
            "nurse_obligations": {
              "committed_hours_per_week": 30,
              "response_time_commitment": "12h",
              "daily_reports": 2,
              "certifications_required": ["sơ cứu", "CPR"],
              "training_frequency": "hàng quý"
            }
          },
          {
            "_id": "price_premium",
            "service_level": "premium",
            "price_range": { "min": 250000, "max": 320000 },
            "elderly_benefits": [
              "Tất cả quyền lợi Standard",
              "Chăm sóc chuyên sâu (Alzheimer, Palliative Care)",
              "Tư vấn chăm sóc dinh dưỡng cá nhân hóa",
              "Kết nối bác sĩ từ xa khi cần"
            ],
            "nurse_obligations": {
              "committed_hours_per_week": 40,
              "response_time_commitment": "4h",
              "daily_reports": 3,
              "certifications_required": [
                "bằng cấp chuyên môn cao",
                "ít nhất 2 chứng chỉ chuyên sâu"
              ],
              "quality_supervision_frequency": "hàng tháng"
            }
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "PhucHwa System",
        "author": "LOC",
        "version": "2.2",
        "year": "2025"
      }
    }
  },
  {
    "_id": "withdraw_requests",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "title": "WithdrawRequestData",
          "type": "object",
          "properties": {
            "_id": {
              "type": "string",
              "description": "ID duy nhất của tài liệu do MongoDB tạo."
            },
            "withdraw_request_id": {
              "type": "string",
              "description": "ID yêu cầu rút tiền (UUID)."
            },
            "nurse_id": {
              "type": "string",
              "description": "ID của nurse yêu cầu rút tiền (tham chiếu đến collection nurses)."
            },
            "amount": {
              "type": "number",
              "minimum": 0,
              "description": "Số tiền muốn rút."
            },
            "status": {
              "type": "string",
              "enum": ["pending", "approved", "rejected", "completed"],
              "description": "Trạng thái yêu cầu rút tiền."
            },
            "bank_account_info": {
              "type": "object",
              "properties": {
                "account_number": {
                  "type": "string",
                  "description": "Số tài khoản ngân hàng."
                },
                "bank_name": {
                  "type": "string",
                  "description": "Tên ngân hàng."
                },
                "crypto_address": {
                  "type": "string",
                  "nullable": true,
                  "description": "Địa chỉ ví crypto (nếu áp dụng)."
                }
              },
              "description": "Thông tin ngân hàng hoặc ví nhận tiền."
            },
            "requested_at": {
              "type": "string",
              "format": "date-time",
              "description": "Thời điểm gửi yêu cầu."
            },
            "processed_at": {
              "type": "string",
              "format": "date-time",
              "nullable": true,
              "description": "Thời điểm xử lý yêu cầu."
            }
          },
          "required": [
            "_id",
            "withdraw_request_id",
            "nurse_id",
            "amount",
            "status",
            "bank_account_info",
            "requested_at"
          ],
          "additionalProperties": false
        },
        "jsonSample": [
          {
            "_id": "wr_001",
            "withdraw_request_id": "wr-uuid-1234567890abcdef",
            "nurse_id": "nurse_001",
            "amount": 1000000,
            "status": "pending",
            "bank_account_info": {
              "account_number": "1234567890",
              "bank_name": "Techcombank",
              "crypto_address": null
            },
            "requested_at": "2025-04-26T09:00:00Z",
            "processed_at": null
          }
        ]
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$match": {
                  "status": "pending"
                }
              },
              {
                "$lookup": {
                  "from": "cards",
                  "localField": "nurse_id",
                  "foreignField": "user_id",
                  "as": "card_info"
                }
              },
              {
                "$addFields": {
                  "current_balance": {
                    "$arrayElemAt": ["$card_info.wallet_balance", 0]
                  }
                }
              },
              {
                "$match": {
                  "current_balance": { "$gte": "$amount" }
                }
              },
              {
                "$addFields": {
                  "new_balance": {
                    "$subtract": ["$current_balance", "$amount"]
                  },
                  "processed_at": {
                    "$dateToString": {
                      "format": "%Y-%m-%dT%H:%M:%SZ",
                      "date": "$$NOW"
                    }
                  }
                }
              },
              {
                "$merge": {
                  "into": "cards",
                  "on": "user_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              },
              {
                "$merge": {
                  "into": "withdraw_requests",
                  "on": "_id",
                  "whenMatched": [
                    {
                      "$set": {
                        "status": "completed",
                        "processed_at": "$processed_at"
                      }
                    }
                  ],
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Pipeline for processing pending withdraw requests, updating wallet balances, and marking requests as completed.",
            "data_input_from_node": ["withdraw_requests", "cards"],
            "data_output_to_node": ["cards", "withdraw_requests"]
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "PhucHwa System",
        "author": "LOC",
        "version": "2.2",
        "year": "2025"
      }
    }
  },

  {
    "_id": "system",
    "public": {
      "node_data": {
        "jsonSchema": {
          "title": "SystemData",
          "type": "object",
          "properties": {
            "_id": { "type": "string" },
            "logoutAllUsersAt": { "type": "string", "format": "date-time" },
            "currentSystemTime": { "type": "string", "format": "date-time" }
          },
          "required": ["_id", "logoutAllUsersAt", "currentSystemTime"],
          "additionalProperties": false
        },
        "jsonSample": [
          {
            "_id": "system_001",
            "logoutAllUsersAt": "2023-10-01T20:00:00Z",
            "currentSystemTime": "2023-10-01T18:00:00Z"
          }
        ]
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$match": {
                  "currentSystemTime": {
                    "$gte": "logoutAllUsersAt"
                  }
                }
              },
              {
                "$set": {
                  "isLoggedIn": false,
                  "tokens": []
                }
              },
              {
                "$merge": {
                  "into": "users",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              },

              {
                "$lookup": {
                  "from": "matching",
                  "localField": "_id",
                  "foreignField": "_id",
                  "as": "matchingData"
                }
              },
              {
                "$unwind": {
                  "path": "$matchingData",
                  "preserveNullAndEmptyArrays": true
                }
              },
              {
                "$set": {
                  "matchingData.isMatched": false,
                  "matchingData.matchedAt": null,
                  "matchingData.resetAt": null
                }
              },
              {
                "$merge": {
                  "into": "matching",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Pipeline for logging out all users and resetting matching data after 20:00.",
            "data_input_from_node": ["users", "matching"],
            "data_output_to_node": ["users", "matching"]
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "PhucHwa System",
        "author": "LOC",
        "version": "2.0",
        "year": "2025"
      }
    }
  }
]
